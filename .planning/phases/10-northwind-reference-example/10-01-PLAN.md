---
phase: 10-northwind-reference-example
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - examples/northwind/northwind.yaml
  - tests/examples/__init__.py
  - tests/examples/test_northwind_spec.py
  - tests/examples/test_northwind_generation.py
  - tests/examples/test_northwind_roundtrip.py
autonomous: true

must_haves:
  truths:
    - "A pre-filled Northwind YAML spec exists at examples/northwind/northwind.yaml covering Orders, Customers, Products, Employees, Suppliers, Categories, and Shippers"
    - "The Northwind spec loads and validates without error via validate_spec()"
    - "Running `architect dab generate` on the Northwind spec produces DDL and DML files that exercise all v0.3.0 features: keyset identity, multi-source staging, composite keys, temporal attributes, knots, ties, bitemporal columns, metadata columns, idempotent DDL/DML"
    - "Generated SQL is deterministic: running generation twice produces byte-identical output"
    - "The Northwind spec can be exported to valid XML (anchor.xsd) and imported back without XML-core field loss"
  artifacts:
    - path: "examples/northwind/northwind.yaml"
      provides: "Complete Northwind Anchor Model spec with inline comments"
      contains: "mnemonic: CU"
    - path: "tests/examples/test_northwind_spec.py"
      provides: "Feature coverage validation tests"
      contains: "test_northwind_includes_keyset_identity"
    - path: "tests/examples/test_northwind_generation.py"
      provides: "SQL generation end-to-end tests"
      contains: "test_northwind_generates_without_errors"
    - path: "tests/examples/test_northwind_roundtrip.py"
      provides: "XML round-trip validation tests"
      contains: "test_northwind_exports_to_valid_xml"
  key_links:
    - from: "examples/northwind/northwind.yaml"
      to: "data_architect.models.spec.Spec"
      via: "validate_spec() -> Spec model"
      pattern: "validate_spec.*northwind"
    - from: "tests/examples/test_northwind_generation.py"
      to: "data_architect.generation"
      via: "generate_all_ddl/generate_all_dml from validated spec"
      pattern: "generate_all_ddl|generate_all_dml"
    - from: "tests/examples/test_northwind_roundtrip.py"
      to: "data_architect.xml_interop"
      via: "export_spec_to_xml/import_xml_to_spec round-trip"
      pattern: "export_spec_to_xml|import_xml_to_spec"
---

<objective>
Create a complete, production-ready Northwind Anchor Model reference example that validates every feature of the v0.3.0 DAB generation pipeline end-to-end, and write a comprehensive automated test suite proving it works.

Purpose: The Northwind example serves three roles: (1) end-to-end validation that all v0.3.0 features work together, (2) a learning resource for users adopting the tool, and (3) a regression test suite for future development. This is the capstone of the v0.3.0 milestone.

Output: `examples/northwind/northwind.yaml` (the spec) + `tests/examples/test_northwind_*.py` (the validation suite)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-northwind-reference-example/10-RESEARCH.md
@src/data_architect/models/spec.py
@src/data_architect/models/anchor.py
@src/data_architect/models/knot.py
@src/data_architect/models/tie.py
@src/data_architect/models/staging.py
@src/data_architect/generation/__init__.py
@src/data_architect/generation/naming.py
@src/data_architect/validation/loader.py
@src/data_architect/validation/errors.py
@src/data_architect/cli.py
@src/data_architect/xml_interop/__init__.py
@tests/fixtures/valid_spec.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Northwind YAML spec with comprehensive inline comments</name>
  <files>examples/northwind/northwind.yaml</files>
  <action>
Create the directory `examples/northwind/` and write `northwind.yaml` — a complete Anchor Model specification for the Northwind Specialty Foods domain.

CRITICAL MODEL CONSTRAINTS (from codebase analysis):
- `staging_mappings` is a YAML-extension field that exists ONLY on the `Anchor` model (not Knot, not Tie)
- StagingMapping fields are: `system` (str), `tenant` (str), `table` (str, NOT "staging_table"), `natural_key_columns` (list[str], NOT "natural_key"), `columns` (list of StagingColumn objects with `name`/`type`/`maps_to` fields), `column_mappings` (dict mapping attribute_mnemonic -> staging_column_name), `priority` (optional int)
- StagingColumn requires both `name` and `type` fields (both are required, not optional)
- Knots have NO staging_mappings field — they are defined with: `mnemonic`, `descriptor`, `identity`, `dataRange`
- Ties have NO staging_mappings field — they are defined with `role` (list of Role objects) and optional `timeRange`
- Role fields: `role` (str), `type` (str, alias for type_), `identifier` (bool)
- Attribute has `knotRange` to reference a knot, and exactly ONE of `knotRange` or `dataRange` must be set (not both, not neither)

The spec must cover these 7 entities (NWND-01):
1. **Customer** (Anchor: CU) — temporal attributes (Name changes, ContactName changes), static attributes (Country)
2. **Product** (Anchor: PR) — MULTI-SOURCE example (Northwind priority=1, SAP priority=2), temporal attributes (Name, UnitPrice, UnitsInStock)
3. **Order** (Anchor: OR) — static attributes (OrderDate, ShippedDate, Freight), knotRange reference to Shipper
4. **Employee** (Anchor: EM) — temporal attributes (LastName, Title), static attributes (HireDate)
5. **Supplier** (Anchor: SU) — at least one temporal attribute, staging mappings
6. **Category** (Knot: CAT) — low-cardinality reference data
7. **Shipper** (Knot: SHP) — low-cardinality reference data

Features that MUST be exercised in the spec:
- Keyset identity: All anchors have staging_mappings with system="northwind", tenant="default"
- Multi-source staging: Product has 2 staging_mappings (northwind + sap) with different priorities
- Composite natural keys: OrderDetail tie has composite key (OrderID + ProductID) — model this by having a tie connecting OR and PR
- Temporal attributes: Several attributes with `timeRange: datetime` (historized)
- Static attributes: Several attributes WITHOUT timeRange (non-historized)
- Knot references: At least one attribute with `knotRange` referencing a knot (e.g., Order's ShipVia -> SHP knot, or Product's Category -> CAT knot)
- Knots: Category and Shipper as knot entities
- Ties: OrderDetail as a tie between Order and Product (with identifier roles)

Include extensive inline YAML comments explaining:
- Business context: "Northwind Traders is a specialty food import/export company"
- Why each entity is modeled as anchor vs knot: "Category is a knot because it's low-cardinality, stable reference data"
- Why certain attributes are temporal vs static: "Customer Name has timeRange because companies rebrand"
- Multi-source reasoning: "Products come from both Northwind and SAP ERP"
- Composite key reasoning: "OrderDetail is a tie with composite natural key (Order + Product)"

The YAML must use the correct aliases for serialization:
- Use `attribute:` (not `attributes:`) — alias in Anchor model
- Use `knot:` (not `knots:`) — alias in Spec model
- Use `anchor:` (not `anchors:`) — alias in Spec model
- Use `tie:` (not `ties:`) — alias in Spec model
- Use `role:` (not `roles:`) — alias in Tie model
- Use `knotRange:` (not `knot_range:`) — alias in Attribute model
- Use `dataRange:` (not `data_range:`) — alias in Attribute model
- Use `timeRange:` (not `time_range:`) — alias in Attribute model
  </action>
  <verify>
Run: `python -c "from data_architect.validation.loader import validate_spec; from pathlib import Path; r = validate_spec(Path('examples/northwind/northwind.yaml')); print(f'Valid: {r.is_valid}, Errors: {len(r.errors)}'); [print(e) for e in r.errors]"`

Expect: Valid: True, Errors: 0
  </verify>
  <done>
- northwind.yaml exists at examples/northwind/northwind.yaml
- The spec validates without error via validate_spec()
- Spec contains all 7 entities: CU (Customer), PR (Product), OR (Order), EM (Employee), SU (Supplier), CAT (Category knot), SHP (Shipper knot)
- Product anchor has 2 staging_mappings (multi-source)
- At least 3 attributes have timeRange set (temporal/historized)
- At least 1 attribute has knotRange referencing a knot
- At least 1 tie with 2+ identifier roles exists (composite key)
- Inline YAML comments explain all modeling decisions
  </done>
</task>

<task type="auto">
  <name>Task 2: Create E2E test suite for spec validation, SQL generation, and XML round-trip</name>
  <files>
tests/examples/__init__.py
tests/examples/test_northwind_spec.py
tests/examples/test_northwind_generation.py
tests/examples/test_northwind_roundtrip.py
  </files>
  <action>
Create `tests/examples/` directory with `__init__.py` (empty) and three test files.

**File 1: tests/examples/test_northwind_spec.py** — Feature coverage validation (no generation needed, fast)

Tests that verify the spec exercises all v0.3.0 features by inspecting the loaded Spec model:
- `test_northwind_spec_loads_without_errors()`: Load via `validate_spec()`, assert `result.is_valid is True` and `result.spec is not None`
- `test_northwind_entities_match_requirement()`: Check all 7 entities exist by descriptor — Customer, Product, Order, Employee, Supplier (anchors) + Category, Shipper (knots)
- `test_northwind_includes_keyset_identity()`: Every anchor has at least one staging_mapping with `system`, `tenant`, `natural_key_columns` set
- `test_northwind_includes_multi_source()`: At least one anchor has `len(staging_mappings) > 1`
- `test_northwind_includes_temporal_attributes()`: At least one attribute has `time_range is not None`
- `test_northwind_includes_static_attributes()`: At least one attribute has `time_range is None`
- `test_northwind_includes_knots()`: `len(spec.knots) >= 2` (Category + Shipper)
- `test_northwind_includes_knot_reference()`: At least one attribute has `knot_range is not None`
- `test_northwind_includes_ties()`: `len(spec.ties) >= 1`
- `test_northwind_includes_column_mappings()`: Every staging_mapping has non-empty `column_mappings` dict
- `test_northwind_includes_staging_columns()`: Every staging_mapping has non-empty `columns` list with StagingColumn objects

Use `validate_spec()` from `data_architect.validation.loader` to load the spec. Use `Path(__file__).resolve().parent.parent.parent / "examples" / "northwind" / "northwind.yaml"` for the spec path (relative to project root from test file location).

**File 2: tests/examples/test_northwind_generation.py** — SQL generation E2E tests

Tests that validate the full generation pipeline works on the Northwind spec:
- `test_northwind_generates_without_errors()`: Call `generate_all_ddl(spec, "postgres")` and `generate_all_dml(spec, "postgres")` — both should return non-empty dicts without raising
- `test_northwind_ddl_file_count()`: DDL dict should have entries for all anchors (5) + knots (2) + tie(s) (1+) + staging tables (count = total staging_mappings across all anchors)
- `test_northwind_dml_file_count()`: DML dict should have entries for all entities with merge operations
- `test_northwind_sql_parses_with_sqlglot()`: Every SQL string in DDL/DML dicts should parse without error via `sqlglot.parse(sql, dialect="postgres")`; use `sqlglot.parse` (not `parse_one`) because files may contain multiple statements
- `test_northwind_ddl_is_idempotent()`: All DDL SQL contains "IF NOT EXISTS" (case-insensitive)
- `test_northwind_includes_bitemporal_columns()`: DDL for an attribute with timeRange contains "changed_at" and "recorded_at"
- `test_northwind_includes_metadata_columns()`: DDL for any anchor table contains "metadata_recorded_at", "metadata_recorded_by", "metadata_id"
- `test_northwind_generation_is_deterministic()`: Generate DDL+DML twice, compare — every file must be byte-identical
- `test_northwind_multi_source_generates_separate_files()`: Product anchor generates separate DML files per source (check for system suffix in filenames: "northwind" and "sap")
- `test_northwind_staging_ddl_includes_keyset_column()`: At least one staging table DDL contains "keyset_id"
- `test_northwind_dml_references_keyset_id()`: At least one DML file contains "keyset_id" (referencing staging column)
- `test_northwind_multi_dialect_compiles()`: `generate_all_ddl(spec, dialect)` succeeds for "postgres", "tsql", "snowflake" without error

Use direct Python API calls (not subprocess), importing `generate_all_ddl`, `generate_all_dml` from `data_architect.generation`. Load spec once via `validate_spec()` in a module-level fixture or at top of each test.

**File 3: tests/examples/test_northwind_roundtrip.py** — XML interoperability tests

Tests that validate the Northwind spec works with XML export/import:
- `test_northwind_exports_to_xml()`: Call `export_spec_to_xml(spec, force=True)` — should return valid XML string without error. The `force=True` is needed because the spec has YAML-only extensions (staging_mappings).
- `test_northwind_exported_xml_is_well_formed()`: Parse the exported XML string with `lxml.etree.fromstring()` — should not raise
- `test_northwind_xml_reimports_without_errors()`: Write exported XML to a temp file, call `import_xml_to_spec(temp_path)` — should return a Spec without error
- `test_northwind_roundtrip_preserves_anchor_count()`: After export→import round-trip, the reimported spec should have the same number of anchors as the original
- `test_northwind_roundtrip_preserves_knot_count()`: Same for knots
- `test_northwind_roundtrip_preserves_tie_count()`: Same for ties
- `test_northwind_check_yaml_extensions()`: Call `check_yaml_extensions(spec)` — should return non-empty list (because spec has staging_mappings)

Import from `data_architect.xml_interop`: `export_spec_to_xml`, `import_xml_to_spec`, `check_yaml_extensions`. Use `tmp_path` pytest fixture for temporary files.

IMPORTANT: All three test files should use `pathlib.Path` for paths. Define `NORTHWIND_SPEC` as a module-level constant resolved relative to project root. Use `pytest` fixtures where appropriate (e.g., a `spec` fixture that loads and validates the spec once).
  </action>
  <verify>
Run: `python -m pytest tests/examples/ -v --tb=short`

Expect: All tests pass. Count should be approximately 20+ tests across the three files.
  </verify>
  <done>
- tests/examples/__init__.py exists (empty)
- tests/examples/test_northwind_spec.py has 10+ tests covering feature presence
- tests/examples/test_northwind_generation.py has 10+ tests covering SQL generation, determinism, idempotency, multi-dialect, multi-source, keyset
- tests/examples/test_northwind_roundtrip.py has 5+ tests covering XML export/import round-trip
- All tests pass via `pytest tests/examples/ -v`
- Full test suite passes: `make check` succeeds
  </done>
</task>

</tasks>

<verification>
1. `python -c "from data_architect.validation.loader import validate_spec; from pathlib import Path; r = validate_spec(Path('examples/northwind/northwind.yaml')); assert r.is_valid, r.errors"` — Spec validates
2. `python -m pytest tests/examples/ -v --tb=short` — All E2E tests pass
3. `python -m pytest tests/ -v --tb=short` — Full test suite passes (no regressions)
4. `make check` — Lint + type + test all pass
</verification>

<success_criteria>
- examples/northwind/northwind.yaml exists and validates without errors
- Spec covers all 7 required entities (5 anchors + 2 knots) with at least 1 tie
- Spec exercises: keyset identity, multi-source staging, composite keys, temporal attributes, knots, knot references, ties, staging column mappings
- 25+ E2E tests pass covering spec validation, SQL generation, determinism, idempotency, multi-dialect, multi-source, keyset identity, XML round-trip
- Full `make check` passes (no regressions in existing 304 tests)
- Generated SQL is deterministic (identical output on repeated generation)
</success_criteria>

<output>
After completion, create `.planning/phases/10-northwind-reference-example/10-01-SUMMARY.md`
</output>
