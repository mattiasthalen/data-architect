---
phase: 02-cli-scaffolding
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - pyproject.toml
  - src/data_architect/cli.py
  - tests/test_cli.py
autonomous: true

must_haves:
  truths:
    - "architect init in an empty directory creates all expected files and prints every file path with a symbol"
    - "architect init with existing files skips them with a warning symbol; --force overwrites"
    - "architect init --dry-run prints what would be created without writing files"
    - "architect init --dir /some/path scaffolds into the specified directory"
    - "architect init --help displays usage; errors produce human-readable messages"
  artifacts:
    - path: "src/data_architect/cli.py"
      provides: "Typer CLI app with init command and all flags"
      exports: ["app"]
    - path: "tests/test_cli.py"
      provides: "CLI integration tests using CliRunner"
      min_lines: 60
    - path: "pyproject.toml"
      provides: "typer added as runtime dependency"
      contains: "typer"
  key_links:
    - from: "src/data_architect/cli.py"
      to: "src/data_architect/scaffold.py"
      via: "import scaffold"
      pattern: "from data_architect\\.scaffold import scaffold"
    - from: "pyproject.toml"
      to: "src/data_architect/cli.py"
      via: "entry point"
      pattern: 'architect = "data_architect.cli:app"'
---

<objective>
Wire the scaffold engine to a Typer CLI with `architect init` command, all flags, symbol-based output, and error handling.

Purpose: Turn the tested scaffold logic into a user-facing CLI command that meets all Phase 2 success criteria.
Output: Working `architect init` command with `--force`, `--dry-run`, `--dir`, `--help` flags and clear output.
</objective>

<execution_context>
@./.Claude/get-shit-done/workflows/execute-plan.md
@./.Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-cli-scaffolding/02-CONTEXT.md
@.planning/phases/02-cli-scaffolding/02-01-SUMMARY.md
@src/data_architect/scaffold.py
@src/data_architect/templates.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Typer dependency and rewrite CLI with init command</name>
  <files>pyproject.toml, src/data_architect/cli.py</files>
  <action>
**Add Typer to pyproject.toml:**
- Add `"typer>=0.15.0"` to `[project] dependencies` (runtime dep, not dev)
- Run `uv sync` to install

**Rewrite `cli.py`** with Typer app:

```python
import typer
app = typer.Typer(help="Data Architect: Scaffold OpenCode AI agents for data warehouse design.")

@app.command()
def init(
    dir: Path = typer.Option(None, "--dir", help="Target directory (default: current directory)"),
    force: bool = typer.Option(False, "--force", help="Overwrite existing files"),
    dry_run: bool = typer.Option(False, "--dry-run", help="Show what would be created without writing"),
) -> None:
    """Scaffold OpenCode agent definitions into your project."""
    ...
```

**Output formatting** — use symbols per user decision:
- `✓` for CREATED (green if possible via typer.style, but don't add rich as a dep — typer includes basic styling)
- `⚠` for SKIPPED (yellow)
- `~` for WOULD_CREATE in dry-run (blue/dim)
- Print each result as: `{symbol} {relative_path}` (one per line)
- At the end, print a summary line: `"Scaffolded N files"` or `"Dry run: N files would be created"` or similar

**Error handling:**
- Target directory doesn't exist: create it (like `mkdir -p`) — don't error
- Target directory not writable: catch `PermissionError`, print human-readable message, exit code 1
- Use `typer.echo()` for output, `typer.Exit(code=1)` for errors

**Important:** The existing entry point `architect = "data_architect.cli:app"` in pyproject.toml already points to `app`. Typer's `app` is callable, so this just works. No entry point change needed.

Run `uv sync` after adding typer dependency.
  </action>
  <verify>`uv sync` succeeds. `uv run architect --help` shows usage. `uv run architect init --help` shows init flags.</verify>
  <done>`architect init --help` displays all flags. Typer is a runtime dependency. CLI wiring is complete.</done>
</task>

<task type="auto">
  <name>Task 2: CLI integration tests and full validation</name>
  <files>tests/test_cli.py</files>
  <action>
**Replace tests in `test_cli.py`** with Typer CLI integration tests using `typer.testing.CliRunner`:

```python
from typer.testing import CliRunner
from data_architect.cli import app

runner = CliRunner()
```

**Tests:**
- `test_init_creates_files_in_empty_dir` — `runner.invoke(app, ["init", "--dir", str(tmp_path)])` returns exit code 0, output contains `✓`, all 9 files exist on disk
- `test_init_default_dir_is_cwd` — invoke without `--dir` using `runner.invoke(app, ["init"], ...)` in a tmp dir, files created in cwd (use monkeypatch to change cwd, or invoke with `--dir`)
- `test_init_skips_existing_files` — pre-create a file, invoke `init`, output contains `⚠` for that file
- `test_init_force_overwrites` — pre-create a file, invoke `init --force`, output contains `✓` for all
- `test_init_dry_run_no_files` — invoke `init --dry-run --dir tmp`, output contains `~`, no files on disk
- `test_init_help` — `runner.invoke(app, ["init", "--help"])` returns exit code 0, output contains `--force`, `--dry-run`, `--dir`
- `test_help_shows_usage` — `runner.invoke(app, ["--help"])` returns exit code 0
- `test_init_prints_summary` — output contains a summary line with file count

Use `tmp_path` fixture for all tests. Check exit codes, output content, and file existence.

Run `make check` — all lint, type, and tests must pass (including existing test_init.py tests).
  </action>
  <verify>`make check` passes. `uv run architect init --dir /tmp/test-scaffold` creates 9 files with symbol output.</verify>
  <done>All CLI tests pass. `architect init` works end-to-end with all flags. `make check` is fully green. Phase 2 success criteria met.</done>
</task>

</tasks>

<verification>
Phase 2 success criteria from ROADMAP.md:
1. `architect init` in empty dir creates all files and prints every path — test with `--dir /tmp/test-verify`
2. `architect init` skips existing files with warning; `--force` overwrites — test by running twice
3. `architect init --dry-run` prints without writing — verify no files created
4. `architect init --dir /some/path` scaffolds into specified dir — verify path
5. `architect init --help` shows usage; errors produce readable messages — verify output
</verification>

<success_criteria>
- `architect init --dir /tmp/test` creates 9 files, prints each with ✓ symbol
- `architect init --dir /tmp/test` again skips all 9 with ⚠ symbol
- `architect init --dir /tmp/test --force` overwrites all 9 with ✓ symbol
- `architect init --dir /tmp/test2 --dry-run` prints 9 lines with ~ symbol, no files on disk
- `architect init --help` shows all flags with descriptions
- `make check` passes with all tests green
</success_criteria>

<output>
After completion, create `.planning/phases/02-cli-scaffolding/02-02-SUMMARY.md`
</output>
