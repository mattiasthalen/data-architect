---
phase: 04-agent-quality-modeling-workflows
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/data_architect/templates.py
  - tests/test_scaffold.py
autonomous: true

must_haves:
  truths:
    - "AGENTS.md contains explicit Anchor Modeling decision trees (anchor vs attribute, historization, tie vs nexus)"
    - "Data Architect agent prompt encodes complete CLP stage protocol with inputs, activities, debate questions, deliverables, and exit criteria per stage"
    - "Data Architect agent prompt encodes bounded iteration debate protocol with convergence detection and user escalation"
  artifacts:
    - path: "src/data_architect/templates.py"
      provides: "Deepened AGENTS.md and data-architect.md template strings"
      contains: "Decision Tree"
    - path: "tests/test_scaffold.py"
      provides: "Tests verifying deepened methodology content"
      contains: "decision_tree"
  key_links:
    - from: "AGENTS.md template"
      to: "data-architect.md template"
      via: "Methodology deep-dive in AGENTS.md referenced by data-architect CLP protocol"
      pattern: "AGENTS\\.md"
    - from: "data-architect.md template"
      to: "Debate termination logic"
      via: "Bounded iteration protocol with convergence indicators"
      pattern: "Convergence|convergence|CONVERGED|STAGNANT"
---

<objective>
Deepen AGENTS.md shared methodology context with explicit Anchor Modeling decision trees and encode the complete CLP debate orchestration protocol (including bounded iteration, convergence detection, and user escalation) in the Data Architect agent prompt.

Purpose: Transform AGENTS.md from a methodology overview into a queryable decision reference, and give Data Architect the full CLP orchestration protocol needed to drive structured multi-agent debate. These two templates form the foundation that all other agents reference -- they must be deepened first.

Output: Updated AGENTS.md and data-architect.md template strings in templates.py with deep methodology content, plus tests verifying the deepened content.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-agent-quality-modeling-workflows/04-RESEARCH.md
@.planning/phases/03-agent-definitions-opencode-integration/03-01-SUMMARY.md
@src/data_architect/templates.py
@tests/test_scaffold.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deepen AGENTS.md with Anchor Modeling decision trees and methodology rules</name>
  <files>src/data_architect/templates.py, tests/test_scaffold.py</files>
  <action>
Update the "AGENTS.md" entry in the TEMPLATES dict in src/data_architect/templates.py. Keep ALL existing content (ADSS architecture, Anchor Modeling concepts, CLP stages overview, USS basics, naming conventions, team interaction rules) and ADD the following new sections after "## Anchor Modeling Core Concepts" and before "## CLP Stages Overview":

**Add section "## Anchor Modeling Decision Trees"** containing:

1. **Anchor vs Attribute Decision Tree** (4-step tree):
   - Step 1: Identity Check -- Does this concept have independent business identity? YES -> continue. NO -> ATTRIBUTE (ask which anchor it describes).
   - Step 2: Existence Check -- Can it exist without reference to another entity? YES -> continue. NO -> likely ATTRIBUTE or TIE.
   - Step 3: Business Question Check -- Does the business ask direct questions about it? ("How many X?", "What's the status of X?") YES -> ANCHOR. NO -> ATTRIBUTE.
   - Step 4: Shared Concept Check -- Is this shared across multiple anchors as reference data? YES -> KNOT. NO -> confirm ATTRIBUTE.
   - If uncertain after all steps -> escalate to @data-architect.

2. **Historization Decision Rules**:
   - Default to historized: true when uncertain ("You can ignore history in queries, but you can't recover lost data")
   - Historize when: value changes over time, business asks time-based questions, source shows update timestamps, business process involves corrections/updates
   - Do NOT historize when: value is immutable by definition (date of birth, creation timestamp), value is a natural key that never changes

3. **Tie vs Nexus Classification**:
   - If relationship is many-to-one (many X to one Y) -> TIE. Read as "many <from> <verb> one <to>"
   - If relationship is many-to-many (many X to many Y) -> NEXUS. Nexus can have its own attributes (e.g., quantity on order line)
   - If one-to-one -> Challenge the assumption. True 1:1 is rare. Usually an attribute or a tie with cardinality constraint.

4. **Knot Identification Criteria**:
   - Shared across multiple anchors (currency used by orders, products, invoices)
   - Small, finite set of values (status codes, country codes, currency codes)
   - Values rarely change (reference data, not transactional)
   - If only used by one anchor -> attribute, not knot

**Also expand the existing "## CLP Stages Overview" section** to add after each stage's current description:

For Conceptual stage, add: "Key debate question: Does this concept deserve independent identity (anchor) or is it a property (attribute)? Apply the Anchor vs Attribute Decision Tree."

For Logical stage, add: "Key debate questions: Is this property a characteristic (attribute) or relationship (tie)? Does this value change over time (historized = true)? Is this reference data shared across anchors (knot candidate)? Apply the Historization Decision Rules and Tie vs Nexus Classification."

For Physical stage, add: "Key concern: Performance optimization must not compromise logical model integrity. Defer physical concerns to the Physical stage -- do not let indexing or partitioning decisions drive entity classification."

**Add tests** in tests/test_scaffold.py:

1. `test_agents_md_has_decision_trees()`: Assert "AGENTS.md" template contains strings "Decision Tree", "Identity Check", "Historization Decision", "Tie vs Nexus"
2. `test_agents_md_has_historization_default()`: Assert "AGENTS.md" template contains "historized: true" default guidance string like "default" and "historized" appearing together

Important: Do NOT change the template count (14 entries). Only modify existing template string content.
  </action>
  <verify>
Run `cd /workspaces/data-architect && make check` -- all tests pass including the new ones. Verify template count is still 14. Verify new test functions exist and pass.
  </verify>
  <done>
AGENTS.md template contains explicit decision trees for anchor-vs-attribute (4 steps), historization rules (with default-to-true guidance), tie-vs-nexus classification, and knot identification criteria. CLP stages overview has key debate questions per stage. Two new tests verify the deepened content. All existing tests still pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Encode CLP debate orchestration and bounded iteration protocol in Data Architect agent</name>
  <files>src/data_architect/templates.py, tests/test_scaffold.py</files>
  <action>
Update the ".opencode/agents/data-architect.md" entry in the TEMPLATES dict. Keep ALL existing content and ADD the following new sections. Insert them after the existing "## Team Orchestration" section and before "## Methodology Context":

**Add section "## CLP Stage Protocols"** containing detailed orchestration instructions for each stage:

**Conceptual Stage: What Entities Exist?**
- Goal: Identify business entities that deserve independent identity (anchors)
- Protocol:
  1. Invoke @business-analyst to identify business entities from domain description and business questions
  2. Invoke @system-analyst to identify technical entities from source schemas
  3. Moderate debate: For each candidate entity, apply Anchor vs Attribute Decision Tree from AGENTS.md
  4. Synthesize into anchor list with business descriptions
- Deliverables: List of anchors with business descriptions, initial attribute candidates, open questions for user
- Exit criteria: All proposed anchors have business justification AND source evidence (or documented exception), no orphan concepts, user confirms entity list

**Logical Stage: How Do Entities Relate?**
- Goal: Define attributes, ties, knots, and nexuses with correct classification, naming, and historization
- Protocol:
  1. For each anchor, classify properties as attributes vs ties vs knots using decision trees from AGENTS.md
  2. Invoke @system-analyst to map source FKs to tie candidates
  3. Invoke @business-analyst to validate relationship directions match business understanding
  4. Debate historization decisions for each attribute using Historization Decision Rules
  5. Invoke @analytics-engineer to validate consumption patterns are supported
  6. Enforce naming conventions (snake_case, double underscore, no mnemonics)
- Deliverables: Complete YAML spec with all elements following naming conventions, historization flags with justification
- Exit criteria: Every attribute has data type and historization flag, every tie has clear many-to-one direction, all names pass convention check, @analytics-engineer confirms business questions are answerable
- After this stage: Invoke @veteran-reviewer for first review pass (focus on structural anti-patterns)

**Physical Stage: How to Implement?**
- Goal: Add performance, indexing, and orchestration recommendations
- Protocol:
  1. Invoke @data-engineer to analyze cardinality and query patterns
  2. Review index recommendations for anchors, ties, time-variant attributes
  3. Review partitioning schemes for high-volume historized attributes
  4. Document orchestration patterns (incremental vs full refresh)
- Deliverables: Physical annotations in YAML spec, index and partitioning recommendations
- Exit criteria: All performance recommendations documented, @data-engineer confirms no severe bottlenecks
- After this stage: Invoke @veteran-reviewer for final review pass (full 10-item checklist)

**Add section "## Debate Protocol"** containing the bounded iteration and convergence detection logic:

**Iteration Limit:** 5 rounds per topic (anchor classification, tie direction, attribute assignment, historization decision)

**Each Round:**
1. @system-analyst presents technical perspective with source evidence
2. @business-analyst presents business perspective with business question evidence
3. You (Data Architect) evaluate convergence

**Convergence Assessment:**
- CONVERGED (positions align): Both use same entity names, agree on classification, agree on historization, positions complement each other -> Synthesize and document consensus, move to next topic
- DIVERGING (positions moving apart): New disagreements emerging, arguments strengthening on both sides -> Continue debate if round < 5, ask focused questions to narrow the gap
- STAGNANT (no progress): Same arguments repeated, no new evidence, talking past each other -> Escalate immediately (more rounds will not help)

**Termination Decision:**
- IF convergence indicators present -> SYNTHESIZE and document consensus
- IF divergence and round < 5 -> CONTINUE with focused questions
- IF divergence and round >= 5 -> ESCALATE to user
- IF stagnation detected at any round -> ESCALATE immediately

**Escalation Format** (present to user when debate cannot converge):
```
We have reached an impasse on: [topic]

System Analyst Position: [summary with source citations]
Business Analyst Position: [summary with business question citations]
Anchor Modeling Constraints: [which methodology rules apply]
My Recommendation: [synthesis with tradeoffs]

What is your decision? [clear options]
```

**Add tests** in tests/test_scaffold.py:

1. `test_data_architect_has_clp_protocols()`: Assert data-architect.md template contains "Conceptual Stage", "Logical Stage", "Physical Stage"
2. `test_data_architect_has_debate_protocol()`: Assert data-architect.md template contains "Debate Protocol", "Convergence", "ESCALATE", "5 rounds"

Important: Do NOT change the template count (14 entries). Only modify existing template string content.
  </action>
  <verify>
Run `cd /workspaces/data-architect && make check` -- all tests pass including the new ones. Verify template count is still 14. Verify data-architect.md template contains CLP stage protocols and debate protocol with bounded iterations.
  </verify>
  <done>
Data Architect agent prompt contains complete CLP stage protocols (Conceptual, Logical, Physical) with inputs, protocol steps, deliverables, and exit criteria for each stage. Debate Protocol section encodes bounded iteration (5 rounds per topic), convergence assessment (CONVERGED/DIVERGING/STAGNANT), termination logic, and structured user escalation format. Two new tests verify the deepened content. All existing tests still pass.
  </done>
</task>

</tasks>

<verification>
Phase-level checks after this plan:
1. `make check` passes (lint, type, test)
2. TEMPLATES dict still has 14 entries (no new files added)
3. AGENTS.md template contains "Decision Tree", "Historization Decision", "Tie vs Nexus", "Knot Identification"
4. data-architect.md template contains "CLP Stage Protocols", "Debate Protocol", "Convergence", "ESCALATE"
5. All 6 agent files still start with "---" (frontmatter preserved)
6. All cross-references (@agent-name) still present
</verification>

<success_criteria>
- AGENTS.md template grew by ~800-1200 words with decision trees and methodology rules
- Data Architect template grew by ~600-1000 words with CLP protocols and debate logic
- 4+ new tests verify the deepened content
- All 33+ existing tests still pass
- Template count unchanged at 14
</success_criteria>

<output>
After completion, create `.planning/phases/04-agent-quality-modeling-workflows/04-01-SUMMARY.md`
</output>
