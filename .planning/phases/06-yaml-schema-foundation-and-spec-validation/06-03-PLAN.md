---
phase: 06-yaml-schema-foundation-and-spec-validation
plan: 03
type: tdd
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/data_architect/cli.py
  - src/data_architect/dab_init.py
  - tests/test_dab_init.py
  - tests/test_cli.py
autonomous: true

must_haves:
  truths:
    - "Running `architect dab init` creates a YAML spec file in the current directory"
    - "The generated YAML contains inline comments explaining anchors, attributes, ties, knots, nexuses, staging mappings, and keyset identity"
    - "The generated YAML is valid — it can be loaded by the validation engine without errors"
    - "Running `architect dab init` when spec.yaml already exists prompts/skips without overwriting (unless --overwrite)"
    - "The output file path is configurable via argument"
  artifacts:
    - path: "src/data_architect/dab_init.py"
      provides: "Pure function generating spec template YAML string with inline comments using ruamel.yaml CommentedMap"
      contains: "def generate_spec_template"
    - path: "src/data_architect/cli.py"
      provides: "Typer `dab init` command wired to dab_init.generate_spec_template"
      contains: "dab"
    - path: "tests/test_dab_init.py"
      provides: "Tests for template generation: comments present, valid structure, all sections"
      min_lines: 60
    - path: "tests/test_cli.py"
      provides: "CLI integration tests for `architect dab init` command"
  key_links:
    - from: "src/data_architect/cli.py"
      to: "src/data_architect/dab_init.py"
      via: "import generate_spec_template"
      pattern: "from data_architect\\.dab_init import"
    - from: "src/data_architect/dab_init.py"
      to: "ruamel.yaml"
      via: "CommentedMap for comment-preserving YAML generation"
      pattern: "from ruamel\\.yaml"
    - from: "tests/test_dab_init.py"
      to: "src/data_architect/validation/loader.py"
      via: "validates generated template loads without errors"
      pattern: "from data_architect\\.validation"
---

<objective>
Implement the `architect dab init` CLI command that scaffolds a blank YAML spec template with inline comments explaining every section of an Anchor Model specification.

Purpose: Users need a starting point for defining their Anchor Model. The template with inline documentation eliminates the need to read external docs — the spec file itself teaches the format. This is SPEC-02.

Output: `dab_init.py` pure function + CLI wiring in `cli.py` + tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/06-yaml-schema-foundation-and-spec-validation/06-RESEARCH.md
@.planning/phases/06-yaml-schema-foundation-and-spec-validation/06-01-SUMMARY.md
@src/data_architect/cli.py
@src/data_architect/scaffold.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED -- Define dab init function and failing tests</name>
  <files>
    src/data_architect/dab_init.py
    tests/test_dab_init.py
  </files>
  <action>
    1. Create `src/data_architect/dab_init.py` with:
       - `def generate_spec_template() -> str` — stub returning empty string for now
       - Uses `ruamel.yaml` with `CommentedMap` and `CommentedSeq` to build a YAML template with:
         - Top-level comment: spec format version, link to anchor modeling docs
         - `anchor` section with comment explaining anchors (entities/events, mnemonic, descriptor, identity)
         - Example anchor with commented fields
         - `attribute` section nested in anchor with comment (properties, mnemonic, data/knot ranges, historized via timeRange)
         - `knot` section with comment (shared value domains, lookup types)
         - `tie` section with comment (relationships between anchors, roles, historized ties)
         - `nexus` section with comment (n-ary relationships, first-class entities with attributes)
         - Staging mappings section comment (YAML extension, column-level mappings, keyset identity)
         - Keyset identity comment explaining `entity@system~tenant|natural_key` format

    2. Write `tests/test_dab_init.py` with failing tests:
       - `test_generate_returns_nonempty_string` — result is non-empty string
       - `test_template_contains_anchor_section` — "anchor" appears in output
       - `test_template_contains_knot_section` — "knot" appears in output
       - `test_template_contains_tie_section` — "tie" appears in output
       - `test_template_contains_nexus_section` — "nexus" appears in output
       - `test_template_contains_anchor_comment` — output contains comment text about anchors (e.g., "entities or events")
       - `test_template_contains_staging_comment` — output contains comment about staging mappings
       - `test_template_contains_keyset_comment` — output contains comment about keyset identity format
       - `test_template_is_valid_yaml` — parse output with ruamel.yaml, no error
       - `test_template_has_example_anchor` — parsed YAML contains at least one example anchor with mnemonic and descriptor
       - `test_template_has_example_attribute` — parsed YAML contains at least one example attribute

    3. Run tests to confirm RED state. Commit: `test(06-03): add failing tests for dab init spec template`
  </action>
  <verify>`uv run pytest tests/test_dab_init.py` -- tests MUST fail (RED state). `uv run ruff check src/data_architect/dab_init.py` passes.</verify>
  <done>Test file and stub function exist. All tests fail because generate_spec_template returns empty string. RED commit created.</done>
</task>

<task type="auto">
  <name>Task 2: GREEN -- Implement template generation and CLI wiring</name>
  <files>
    src/data_architect/dab_init.py
    src/data_architect/cli.py
    tests/test_dab_init.py
    tests/test_cli.py
  </files>
  <action>
    1. Implement `generate_spec_template()` in `dab_init.py`:
       - Use `ruamel.yaml.YAML()` with `default_flow_style=False`, `width=4096` (prevent wrapping)
       - Build `CommentedMap` structure:
         a. Top-level header comment: "Anchor Model Specification\nFormat: Data Architect YAML (superset of anchor.xsd)\nDocs: https://anchormodeling.com"
         b. `anchor` key (CommentedSeq of CommentedMap):
            - Comment before: explains anchors = entities/events, fields: mnemonic (unique 2-3 letter code), descriptor (name), identity (surrogate key type)
            - One example anchor: `{mnemonic: "XX", descriptor: "ExampleEntity", identity: "int"}` with nested `attribute` list containing one example attribute with dataRange
            - EOL comments on fields: mnemonic -> "Unique 2-3 letter code", descriptor -> "Human-readable name"
         c. `knot` key (CommentedSeq):
            - Comment: shared value domains / lookup types, fields: mnemonic, descriptor, identity, dataRange
            - One example knot
         d. `tie` key (CommentedSeq):
            - Comment: relationships between anchors, each tie has 2+ roles, optional timeRange for historized ties
            - One example tie with two roles
         e. `nexus` key (CommentedSeq):
            - Comment: n-ary relationships, first-class entities with their own attributes and identifiers
            - One example (can be empty list with comment)
         f. After main sections, add a comment block about YAML extensions:
            - Staging mappings: explain staging_mappings field on anchors, column-level mapping from staging tables
            - Keyset identity: explain `entity@system~tenant|natural_key` format
            - Note these are YAML extensions not present in anchor.xsd
       - Dump to string via `StringIO` and return

    2. Wire CLI in `cli.py`:
       - Add a `dab` Typer sub-app: `dab_app = typer.Typer(help="DAB specification management.")`
       - Register: `app.add_typer(dab_app, name="dab")`
       - Add `init` command on `dab_app`:
         ```python
         @dab_app.command()
         def dab_init(
             output: Path = typer.Argument(
                 default=Path("spec.yaml"),
                 help="Output file path (default: spec.yaml)"
             ),
             overwrite: bool = typer.Option(
                 False, "--overwrite",
                 help="Overwrite existing file"
             ),
         ) -> None:
         ```
       - If output exists and not overwrite: print error and exit 1
       - Otherwise: call `generate_spec_template()`, write to output, print success message
       - Follow the existing pattern in cli.py (symbols, styles, echo)

    3. Add CLI integration tests to `tests/test_cli.py`:
       - `test_dab_init_creates_spec_file` — `architect dab init` in tmp dir creates spec.yaml
       - `test_dab_init_custom_output` — `architect dab init custom.yaml` creates custom.yaml
       - `test_dab_init_no_overwrite` — running twice without --overwrite exits with error on second run
       - `test_dab_init_overwrite_flag` — running twice with --overwrite succeeds
       - `test_dab_init_help` — `architect dab init --help` exits 0 and shows help text

    4. Adjust any tests if needed. Ensure the generated template is valid YAML that parses cleanly.

    5. Run `make check` — full quality gate green. Coverage >= 90%.

    6. Commit: `feat(06-03): implement dab init command with commented YAML spec template`

    IMPORTANT: The project uses Typer, not Click. Use `typer.Typer()` sub-app pattern for the `dab` command group. The existing CLI uses `app = typer.Typer()` with `@app.callback()`.

    IMPORTANT: Follow the pure-function pattern from scaffold.py: `generate_spec_template()` is a pure function returning a string. CLI layer just calls it and writes to disk. No business logic in cli.py.

    IMPORTANT: Add ruff per-file-ignores for `dab_init.py` if it contains long comment strings (E501), similar to templates.py.
  </action>
  <verify>`make check` passes. `uv run pytest tests/test_dab_init.py tests/test_cli.py -v` shows all tests passing. `architect dab init --help` works. Coverage >= 90%.</verify>
  <done>`architect dab init` creates a YAML spec template with inline comments explaining anchors, attributes, ties, knots, nexuses, staging mappings, and keyset identity. Template is valid YAML. Overwrite protection works. CLI integration tests pass. Full quality gate green.</done>
</task>

</tasks>

<verification>
1. `architect dab init --help` shows help text for the init command
2. `architect dab init /tmp/test_spec.yaml` creates the file
3. `cat /tmp/test_spec.yaml` shows YAML with inline comments explaining each section
4. Template contains: anchor section, knot section, tie section, nexus section, staging comment, keyset comment
5. `uv run python -c "from ruamel.yaml import YAML; YAML().load(open('/tmp/test_spec.yaml'))"` succeeds (valid YAML)
6. `uv run pytest tests/test_dab_init.py tests/test_cli.py -v` -- all tests pass
7. `make check` -- full quality gate green
</verification>

<success_criteria>
- `architect dab init` creates a YAML spec file with inline comments
- Comments explain: anchors (entities/events), attributes (properties), ties (relationships), knots (shared values), nexuses (n-ary relationships), staging mappings (YAML extension), keyset identity format
- Generated YAML is valid and parseable
- Example anchor with example attribute included in template
- Overwrite protection: exits with error if file exists (unless --overwrite)
- Custom output path supported via argument
- Pure function pattern: generate_spec_template() returns string, CLI just writes
- CLI integration tests cover create, overwrite protection, custom path, help
- make check fully green with coverage >= 90%
</success_criteria>

<output>
After completion, create `.planning/phases/06-yaml-schema-foundation-and-spec-validation/06-03-SUMMARY.md`
</output>
