---
phase: 03-agent-definitions-opencode-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/data_architect/templates.py
autonomous: true

must_haves:
  truths:
    - "After architect init, AGENTS.md contains full ADSS three-layer architecture, Anchor Modeling concepts, CLP overview, USS basics, naming conventions, and team interaction rules (~500-1000 words)"
    - "After architect init, opencode.json has no hardcoded model assignments but includes tier placeholder comment and default_agent set to data-architect"
    - "After architect init, .opencode/agents/ contains 6 agent Markdown files with valid YAML frontmatter and real prompts (not TODO stubs)"
    - "After architect init, example YAML spec schemas exist showing anchor, attribute, tie, knot, and nexus structure"
    - "Each agent prompt includes role description, brief methodology context, cross-references to other agents by @name, and YAML frontmatter with description and mode"
    - "Veteran Reviewer agent includes a basic anti-pattern checklist of 5-10 concrete items"
    - "Agent YAML frontmatter does NOT include hardcoded model assignments (no model field, or placeholder comment)"
  artifacts:
    - path: "src/data_architect/templates.py"
      provides: "Complete TEMPLATES dict with AGENTS.md, opencode.json, spec schemas, and all 6 agent prompts"
      contains: "TEMPLATES"
  key_links:
    - from: "src/data_architect/templates.py"
      to: "src/data_architect/scaffold.py"
      via: "TEMPLATES dict import"
      pattern: "from data_architect.templates import TEMPLATES"
    - from: "agent prompts in TEMPLATES"
      to: "AGENTS.md in TEMPLATES"
      via: "agents reference 'See AGENTS.md'"
      pattern: "AGENTS\\.md"
---

<objective>
Write the shared methodology context (AGENTS.md), OpenCode configuration (opencode.json), example YAML spec schemas, and all six agent prompts as real content in the TEMPLATES dict, replacing Phase 2 stubs.

Purpose: This is the core content authoring for Phase 3 -- creating the actual agent team definitions that OpenCode will recognize. AGENTS.md provides the shared methodology foundation, opencode.json configures the platform, spec schemas give agents a reference format, and agent prompts define each team member's role, expertise, and team awareness.

Output: Updated `src/data_architect/templates.py` with complete content for AGENTS.md, opencode.json, 2-3 spec schema files, and all 6 agent Markdown files with real prompts.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-agent-definitions-opencode-integration/03-CONTEXT.md
@.planning/phases/03-agent-definitions-opencode-integration/03-RESEARCH.md
@.planning/phases/02-cli-scaffolding/02-01-SUMMARY.md
@src/data_architect/templates.py
@src/data_architect/scaffold.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write shared context, config, and spec schema templates</name>
  <files>src/data_architect/templates.py</files>
  <action>
Replace the stub content for AGENTS.md, opencode.json, and add new spec schema entries in the TEMPLATES dict.

**AGENTS.md** (~500-1000 words of content):
Write a comprehensive methodology primer with these sections:
1. **ADSS Three-Layer Architecture**: Explain DAS (Data According to System -- raw/source data, minimal transformation), DAB (Data According to Business -- Anchor Modeling, the debate layer), DAR (Data According to Requirements -- Unified Star Schema, consumption). Explain unidirectional flow DAS -> DAB -> DAR.
2. **Anchor Modeling Core Concepts**: Define anchors (immutable entity identity), attributes (historized properties -- each is its own table), ties (many-to-one relationships between anchors), knots (shared reference/lookup data), nexuses (many-to-many intersections). Emphasize non-destructive schema evolution (additive only).
3. **CLP Stages Overview**: Explain Conceptual (what entities exist, their business meaning), Logical (how entities relate, attribute classification, tie direction), Physical (implementation details, indexing, partitioning). Note: detailed debate protocol is Phase 4.
4. **USS Basics**: Unified Star Schema -- single bridge table connecting dimensions to facts, eliminates fan/chasm traps.
5. **Naming Conventions** (per locked decisions -- exact format):
   - `anchor__<entity>` (e.g., `anchor__order`)
   - `anchor__<entity>__<attribute>` (e.g., `anchor__order__order_date`)
   - `tie__<from>__<verb>__<to>` -- always many-to-one (e.g., `tie__order__placed_by__customer`)
   - `knot__<name>` (e.g., `knot__currency`)
   - `nexus__<name>` (e.g., `nexus__order_line`)
   - Rules: snake_case only, double underscore `__` as separator, NO mnemonics, full readable names
6. **Team Interaction Rules**: List the 6 agents by role. State debate expectations (System Analyst and Business Analyst argue perspectives, Data Architect synthesizes, Veteran Reviewer critiques). Escalation path: unresolved disputes go to user. User is final authority on all modeling decisions.

**opencode.json** (per locked decisions):
Replace the stub with valid JSON containing:
- `"$schema": "https://opencode.ai/config.json"`
- `"name": "data-architect"`
- `"default_agent": "data-architect"`
- `"agents"` object with `"data-architect": {"mode": "primary"}` entry
- `"instructions": ["AGENTS.md"]`
- `"autoupdate": true`
- `"_comment"` explaining the three-tier model profile system: "Model tier (budget/standard/high) will be configured by Data Architect agent on first /da:start interaction. Budget=fast+cheap, Standard=balanced, High=maximum quality."
- Do NOT include any hardcoded model assignments per locked decision
- NOTE: OCODE-03 ("model assignments") is interpreted as structure ready for model assignments (tier placeholder comment, config shape), not containing actual assignments at init time, per locked decision "Scaffolds with placeholder/no model assignments." The tier placeholder comment satisfies the readiness requirement.

**Example YAML spec schemas** (OCODE-05):
Add 2 new template entries:
- `.data-architect/specs/examples/anchor-example.yaml` -- example showing an anchor with 2-3 attributes, demonstrating naming convention, required fields (name, description, attributes list with name/type/historized flag)
- `.data-architect/specs/examples/domain-example.yaml` -- example showing a small domain (e.g., e-commerce with customer anchor, order anchor, a tie between them, a knot for currency) demonstrating how anchors/ties/knots compose into a domain spec

Use YAML format. Include comments in the YAML explaining each field. Use the exact naming conventions from CONTEXT.md (snake_case, double underscore separators, no mnemonics).

Spec output location: `.data-architect/specs/` per research recommendation (separate from .opencode/ config, clear ownership).

**Important constraints:**
- All template content is plain Python strings in the TEMPLATES dict (no Jinja2, no f-strings with runtime variables)
- Keep the dict ordered: agents first, then skills, then AGENTS.md, then opencode.json, then spec schemas (or similar logical grouping)
- Do NOT modify agent stub entries yet (those are Task 2) -- only modify AGENTS.md, opencode.json, and add new spec schema entries in this task
  </action>
  <verify>
Run `python -c "from data_architect.templates import TEMPLATES; print(len(TEMPLATES)); [print(k) for k in TEMPLATES.keys()]"` to confirm all template keys exist and count is correct (should be 11: 6 agents + 1 skill + AGENTS.md + opencode.json + 2 spec schemas).
  </verify>
  <done>
TEMPLATES dict contains 11 entries. AGENTS.md entry has 500+ words of methodology content covering all 6 sections. opencode.json has valid JSON with tier placeholder and no model assignments. Two example spec schema files exist with correct naming conventions and YAML structure.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write all six agent prompt bodies</name>
  <files>src/data_architect/templates.py</files>
  <action>
Replace the 6 agent stub entries in TEMPLATES with full agent prompts. Each agent Markdown file has YAML frontmatter + Markdown body.

**CRITICAL: Remove `model:` field from all 6 existing agent stubs.** The current stubs each contain `model: anthropic:claude-sonnet-4-20250514` in their YAML frontmatter. When replacing stubs with full prompts, the new YAML frontmatter MUST NOT include any `model:` field. This is a locked decision: "Scaffolds with placeholder/no model assignments -- agents are NOT pre-assigned to specific models."

**YAML frontmatter for ALL agents** (per research patterns):
- `description`: One-line role summary (keep existing descriptions, they're good)
- `mode`: "primary" for data-architect, "subagent" for all others
- `temperature`: 0.3 for data-architect (balanced synthesis), 0.1 for data-engineer and veteran-reviewer (precision), 0.5 for system-analyst and business-analyst (creative debate), 0.3 for analytics-engineer
- `tools`: Object with read/write/bash permissions (Claude's discretion -- see below)
- `permissions`: Object with edit/Task permissions
- Do NOT include `model` field -- per locked decision, no model pre-assignment. The existing stubs have `model: anthropic:claude-sonnet-4-20250514` which MUST be removed, not carried forward.

**Tool permissions** (Claude's discretion):
- data-architect: `read: true, write: true, bash: ask` (needs to read source docs and write specs)
- system-analyst: `read: true, write: false, bash: ask` (reads source schemas, doesn't write)
- business-analyst: `read: true, write: false, bash: false` (advisory role, no system access)
- data-engineer: `read: true, write: false, bash: ask` (reads designs, may need to check system)
- analytics-engineer: `read: true, write: false, bash: false` (advisory on consumption patterns)
- veteran-reviewer: `read: true, write: false, bash: false` (pure review role, no modifications)

**Markdown body for each agent** (~80-150 lines each):

**data-architect.md** (primary agent, entry point):
- H1: "Data Architect"
- "You are the Data Architect..." section: Entry point, design authority, Anchor Modeling expertise
- "Your Role": Gather business context, read source docs from filesystem, orchestrate CLP debate, synthesize recommendations, enforce naming standards
- "Team Orchestration": List all 5 subagents by @name, brief description of when to invoke each. Mention @business-analyst for domain perspective, @system-analyst for source system analysis, @data-engineer for physical modeling, @analytics-engineer for consumption perspective, @veteran-reviewer for final critique
- "Methodology Context": Brief ADSS/AM reminder, reference "See AGENTS.md for full methodology"
- "First Interaction Protocol": On first `/da:start`, ask user to choose model tier (budget/standard/high), explain what each means, then write selection to opencode.json
- "Output Format": Agents produce YAML specs following the examples in `.data-architect/specs/examples/`

**system-analyst.md** (source system expert):
- H1: "System Analyst"
- Role: Technical expert on source systems. Understands data structures, system constraints, what data exists and how it's structured technically.
- "Your Perspective": Default position is source-system fidelity -- advocate for preserving source semantics. Challenge @business-analyst when business interpretation diverges from source reality.
- "When Invoked": @data-architect invokes you for source system analysis. Read source schemas (Swagger, OData, ERD) from filesystem when pointed to them.
- Cross-refs: @data-architect (your orchestrator), @business-analyst (your debate counterpart)
- Reference AGENTS.md for methodology

**business-analyst.md** (business domain expert):
- H1: "Business Analyst"
- Role: Business domain expert. Understands what the business needs, how they think about their data, what questions they ask.
- "Your Perspective": Default position is business meaning -- advocate for how the business actually uses and thinks about data. Challenge @system-analyst when source structure obscures business meaning.
- "When Invoked": @data-architect invokes you for domain requirements. Translate business questions into modeling requirements.
- Cross-refs: @data-architect (your orchestrator), @system-analyst (your debate counterpart)
- Reference AGENTS.md for methodology

**data-engineer.md** (physical modeling):
- H1: "Data Engineer"
- Role: Physical modeling specialist. Performance, indexing, partitioning, orchestration.
- "Your Focus": Translate Anchor Model designs into performant physical implementations. Consider historization performance, attribute table indexing, tie query patterns.
- "When Invoked": @data-architect invokes you after logical model is drafted. Provide specific, actionable recommendations.
- Cross-refs: @data-architect (your orchestrator)
- Reference AGENTS.md for methodology

**analytics-engineer.md** (DAR consumption):
- H1: "Analytics Engineer"
- Role: DAR layer perspective. Understands how the warehouse will be consumed -- reports, dashboards, APIs.
- "Your Focus": Evaluate proposed DAB designs from consumption perspective. Will this model support the business questions identified? Can Unified Star Schema (USS) be cleanly derived?
- "When Invoked": @data-architect invokes you to validate consumption patterns after DAB design.
- Cross-refs: @data-architect (your orchestrator), @business-analyst (for business question context)
- Reference AGENTS.md for methodology

**veteran-reviewer.md** (grumpy critic):
- H1: "Veteran Reviewer"
- Role: Battle-scarred DW engineer who's seen every anti-pattern since the early days of data warehousing. Grumpy, direct, pulls no punches.
- "Your Persona": You've survived Kimball vs Inmon wars, seen Data Vault hype cycles, and cleaned up after a hundred "we'll fix it later" decisions. Your job is to find what everyone else missed.
- "Anti-Pattern Checklist" (5-10 items per locked decision):
  1. God anchor (anchor with 20+ attributes -- should be split)
  2. Missing historization (attribute that changes over time but marked static)
  3. Circular ties (A -> B -> C -> A -- signals modeling confusion)
  4. Tie masquerading as anchor (relationship reified unnecessarily)
  5. Orphan anchors (no ties to anything -- is this really an entity?)
  6. Knot overuse (using knots for things that aren't shared reference data)
  7. Naming violations (mnemonics, wrong separators, unclear names)
  8. Missing business context (attribute exists but nobody can explain why)
  9. Premature physical optimization (partitioning decisions before logical model is stable)
  10. Anchor/attribute confusion (what should be an attribute is modeled as a separate anchor)
- "When Invoked": @data-architect invokes you for final review after design is drafted. Be specific. Cite the checklist. Give actionable fix recommendations.
- Cross-refs: @data-architect (your orchestrator)
- Reference AGENTS.md for methodology

**Critical constraints:**
- Agent prompts reference each other by @name (e.g., "@business-analyst", "@data-architect") per locked decision
- No hardcoded model in YAML frontmatter per locked decision -- the existing `model: anthropic:claude-sonnet-4-20250514` in all 6 stubs MUST be removed
- Keep prompts to ~100-200 lines each (structural depth, not behavioral depth -- Phase 4 adds CLP debate protocol)
- Prompts include inline reference to spec schema examples in `.data-architect/specs/examples/` (Claude's discretion: reference, not inline)
  </action>
  <verify>
Run `make check` -- all lint, type, and tests must pass. Then run `python -c "from data_architect.templates import TEMPLATES; agents = [k for k in TEMPLATES if '.opencode/agents/' in k]; print(f'{len(agents)} agents'); [print(k, ':', len(TEMPLATES[k].splitlines()), 'lines') for k in agents]"` to confirm all 6 agents exist with substantial content (not stubs). Additionally verify no agent contains `model:` in frontmatter: `python -c "from data_architect.templates import TEMPLATES; [print('FAIL:', k) for k in TEMPLATES if '.opencode/agents/' in k and 'model:' in TEMPLATES[k].split('---')[1]]"` should produce no output.
  </verify>
  <done>
All 6 agent entries in TEMPLATES have real prompts (not TODO stubs). Each agent has valid YAML frontmatter (description, mode, temperature, tools, permissions -- no model field). The `model: anthropic:claude-sonnet-4-20250514` line from Phase 2 stubs has been removed from all 6 agents. Each prompt body includes role description, methodology context reference, cross-references to other agents by @name. Veteran Reviewer has 10-item anti-pattern checklist. `make check` passes.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from data_architect.templates import TEMPLATES; print(len(TEMPLATES))"` outputs 11 (6 agents + 1 skill + AGENTS.md + opencode.json + 2 spec schemas)
2. All 6 agent files start with `---` (YAML frontmatter)
3. No agent file contains `model:` in frontmatter (per locked decision -- verified: existing `model: anthropic:claude-sonnet-4-20250514` removed)
4. All agent files contain at least one `@` cross-reference to another agent
5. AGENTS.md contains naming conventions with double underscore examples
6. opencode.json contains `"default_agent": "data-architect"` and tier comment
7. Example spec schemas use correct naming conventions (snake_case, __)
8. `make check` passes (lint + type + test)
</verification>

<success_criteria>
- TEMPLATES dict has 11 entries total (up from 9)
- AGENTS.md has 500+ words of methodology content
- opencode.json has valid JSON with tier placeholder system
- 2 example spec schemas demonstrate Anchor Modeling naming conventions
- All 6 agent prompts have real content (role, methodology, cross-references)
- Veteran Reviewer has 5-10 item anti-pattern checklist
- No model assignments in any agent frontmatter (existing `model:` lines removed)
- `make check` passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-agent-definitions-opencode-integration/03-01-SUMMARY.md`
</output>
