---
phase: 08.1-staging-keyset-single-source-of-truth
plan: 02
subsystem: database
tags: [sqlglot, dml, keyset-identity, computed-column, staging]

# Dependency graph
requires:
  - phase: 08.1-staging-keyset-single-source-of-truth
    plan: 01
    provides: keyset_id computed column in staging DDL
provides:
  - Simplified _build_metadata_id_expr() referencing source.keyset_id
  - PostgreSQL templates with source alias
  - Static attribute DO UPDATE SET using EXCLUDED pattern
affects: [dml-generation, staging-load, sql-clarity]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Reference pre-computed columns instead of inline duplication
    - PostgreSQL INSERT SELECT with explicit source alias
    - EXCLUDED references in ON CONFLICT DO UPDATE SET

key-files:
  created: []
  modified:
    - src/data_architect/generation/dml.py
    - tests/test_dml.py

key-decisions:
  - "DML references staging.keyset_id instead of computing inline"
  - "PostgreSQL templates alias staging table as source for consistency"
  - "Static DO UPDATE SET uses EXCLUDED.metadata_id (from inserted values)"

patterns-established:
  - "_build_metadata_id_expr() returns 'source.keyset_id' when mapping provided"
  - "All PostgreSQL templates use 'AS source' in FROM clause"
  - "ON CONFLICT DO UPDATE SET references EXCLUDED for computed expressions"

# Metrics
duration: 4min
completed: 2026-02-10
---

# Phase 08.1 Plan 02: DML Simplification Summary

**DML MERGE statements now reference source.keyset_id instead of computing 148-319 char keyset expressions inline**

## Performance

- **Duration:** 4 minutes
- **Started:** 2026-02-10T08:40:44Z
- **Completed:** 2026-02-10T08:45:02Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments

- Simplified _build_metadata_id_expr() to return source.keyset_id reference (3 lines vs 68 lines)
- Updated PostgreSQL templates to alias staging table as source for keyset_id reference
- Static attribute DO UPDATE SET uses EXCLUDED.metadata_id pattern (cleaner than re-expression)
- Removed 3 unused imports: build_keyset_expr, build_composite_natural_key_expr, escape_delimiters
- Updated 4 keyset tests to verify source.keyset_id pattern
- Added 3 new tests: source alias, EXCLUDED pattern, SQL length verification

## Task Commits

Single atomic commit combining implementation and tests:

1. **Tasks 1 & 2: Simplify DML and update tests** - `8e069fe` (feat)

## Files Created/Modified

- `src/data_architect/generation/dml.py` - Simplified _build_metadata_id_expr() from 68 lines to 3 lines, added source alias to PostgreSQL templates, EXCLUDED pattern in DO UPDATE SET
- `tests/test_dml.py` - Updated 4 tests to verify keyset_id reference pattern, added 3 new tests for source alias, EXCLUDED, and SQL length

## Decisions Made

**1. Reference source.keyset_id instead of inline computation**
- Rationale: Single source of truth - keyset computed once in DDL, referenced in DML
- Impact: Reduces DML SQL length by 148-319 characters per MERGE statement
- Verification: test_dml_keyset_reference_is_shorter confirms simplification

**2. PostgreSQL templates alias staging table as source**
- Rationale: source.keyset_id reference requires explicit alias for consistency across dialects
- Implementation: All PostgreSQL templates now use "FROM {source_table} AS source"
- Side benefit: Consistent with tsql/snowflake templates which already use source alias

**3. Static DO UPDATE SET uses EXCLUDED.metadata_id**
- Rationale: In PostgreSQL ON CONFLICT DO UPDATE SET, source alias isn't available, but EXCLUDED (the proposed INSERT row) contains the computed values
- Implementation: Changed from `metadata_id = {metadata_id_sql}` to `metadata_id = EXCLUDED.metadata_id`
- Benefit: Works with both keyset_id reference and 'architect-generated' fallback

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - implementation was straightforward.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

Phase 08.1 complete. Ready for Phase 9:
- Staging DDL includes keyset_id computed column (Plan 01)
- DML references keyset_id instead of inline computation (Plan 02)
- SQL is cleaner, shorter, and maintains single source of truth

## Self-Check: PASSED

Verified all claims:

```bash
# Check modified files exist
$ [ -f "src/data_architect/generation/dml.py" ] && echo "FOUND: dml.py" || echo "MISSING"
FOUND: dml.py

$ [ -f "tests/test_dml.py" ] && echo "FOUND: test_dml.py" || echo "MISSING"
FOUND: test_dml.py

# Check commit exists
$ git log --oneline --all | grep -q "8e069fe" && echo "FOUND: 8e069fe" || echo "MISSING"
FOUND: 8e069fe

# Verify _build_metadata_id_expr simplified
$ grep "source.keyset_id" src/data_architect/generation/dml.py
    return "source.keyset_id"

# Verify source alias in PostgreSQL templates
$ grep -c "AS source" src/data_architect/generation/dml.py
9

# Verify tests pass
$ python -m pytest tests/test_dml.py -q
..................................                                       [100%]
34 passed in 1.45s
```

All files, commits, and functionality verified.

---
*Phase: 08.1-staging-keyset-single-source-of-truth*
*Completed: 2026-02-10*
