---
phase: 08.1-staging-keyset-single-source-of-truth
plan: 01
subsystem: database
tags: [sqlglot, ddl, keyset-identity, computed-column, staging]

# Dependency graph
requires:
  - phase: 08-keyset-identity-and-staging-mappings
    provides: keyset_sql.py with build_keyset_expr() and build_composite_natural_key_expr()
provides:
  - build_keyset_column() function in columns.py for materialized keyset identity
  - Staging DDL with keyset_id computed column (single source of truth)
  - Multi-dialect computed column support (postgres, tsql, snowflake)
affects: [08.1-02-dml-simplification, dml-generation, staging-load]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Computed columns in SQLGlot using ComputedColumnConstraint with persisted=True
    - Optional anchor/mapping parameters for backward-compatible feature addition

key-files:
  created: []
  modified:
    - src/data_architect/generation/columns.py
    - src/data_architect/generation/ddl.py
    - tests/test_ddl.py

key-decisions:
  - "SQLGlot ComputedColumnConstraint transpiles correctly to dialect-specific syntax"
  - "Composite natural keys escape delimiters after concatenation, not before"
  - "Backward compatibility via optional anchor/mapping parameters"

patterns-established:
  - "build_keyset_column() returns sge.ColumnDef with ComputedColumnConstraint"
  - "Staging DDL builders accept optional anchor/mapping for keyset generation"

# Metrics
duration: 6min
completed: 2026-02-10
---

# Phase 08.1 Plan 01: Staging Keyset DDL Summary

**Materialized keyset_id computed column in staging DDL eliminates 148-319 char inline duplication across DML statements**

## Performance

- **Duration:** 6 minutes
- **Started:** 2026-02-10T08:30:37Z
- **Completed:** 2026-02-10T08:37:17Z
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments
- build_keyset_column() function generates keyset_id as VARCHAR(500) GENERATED ALWAYS AS ... STORED
- Single natural key support via build_keyset_expr() from keyset_sql.py
- Composite natural key support with NULL propagation and ':' separator escaping
- Multi-dialect: postgres (GENERATED ALWAYS AS...STORED), tsql/snowflake (AS...PERSISTED)
- Backward compatible: build_staging_table() works with or without anchor/mapping

## Task Commits

Each task was committed atomically:

1. **Task 1: TDD RED -- Write failing tests for keyset_id computed column** - `ef622c1` (test)
2. **Task 2: TDD GREEN -- Implement build_keyset_column() and update staging DDL builders** - `58300d0` (feat)

_Note: TDD tasks committed RED and GREEN separately_

## Files Created/Modified
- `src/data_architect/generation/columns.py` - Added build_keyset_column() returning ColumnDef with ComputedColumnConstraint
- `src/data_architect/generation/ddl.py` - Updated build_staging_table() and generate_all_ddl() to pass anchor/mapping context
- `tests/test_ddl.py` - Added 6 tests for keyset column generation, multi-dialect, and integration

## Decisions Made

**1. SQLGlot ComputedColumnConstraint with persisted=True**
- Rationale: SQLGlot automatically transpiles to dialect-specific syntax (GENERATED ALWAYS AS...STORED for postgres, AS...PERSISTED for tsql/snowflake)
- Verification: Multi-dialect test confirms correct syntax for all 3 dialects

**2. Composite key delimiter escaping after concatenation**
- Rationale: build_composite_natural_key_expr() already handles ':' separator and NULL propagation. We escape the composite result, not individual components.
- Implementation: Wrap composite expression in nested REPLACE() calls for @, ~, | delimiters

**3. Backward compatibility via optional parameters**
- Rationale: Existing tests calling build_staging_table() without anchor/mapping must continue to work
- Implementation: anchor and mapping parameters default to None; keyset column only added when both provided

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

**1. SQLGlot dialect-specific computed column syntax**
- Issue: Initial test expected all dialects to use GENERATED ALWAYS AS...STORED, but Snowflake uses AS...PERSISTED
- Resolution: Updated test to check dialect-specific syntax (postgres: GENERATED ALWAYS AS, tsql/snowflake: AS...PERSISTED)
- Root cause: SQLGlot transpilation behavior for ComputedColumnConstraint varies by dialect

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

Ready for Phase 08.1 Plan 02 (DML simplification):
- Staging DDL now includes keyset_id computed column
- DML can reference staging.keyset_id instead of computing inline
- Expected reduction: 148-319 chars per MERGE statement

## Self-Check: PASSED

Verified all claims:

```bash
# Check created/modified files exist
$ [ -f "src/data_architect/generation/columns.py" ] && echo "FOUND: columns.py" || echo "MISSING"
FOUND: columns.py

$ [ -f "src/data_architect/generation/ddl.py" ] && echo "FOUND: ddl.py" || echo "MISSING"
FOUND: ddl.py

$ [ -f "tests/test_ddl.py" ] && echo "FOUND: test_ddl.py" || echo "MISSING"
FOUND: test_ddl.py

# Check commits exist
$ git log --oneline --all | grep -q "ef622c1" && echo "FOUND: ef622c1" || echo "MISSING"
FOUND: ef622c1

$ git log --oneline --all | grep -q "58300d0" && echo "FOUND: 58300d0" || echo "MISSING"
FOUND: 58300d0

# Verify build_keyset_column exists
$ grep -q "def build_keyset_column" src/data_architect/generation/columns.py && echo "FOUND: build_keyset_column" || echo "MISSING"
FOUND: build_keyset_column

# Verify tests pass
$ python -m pytest tests/test_ddl.py -k "keyset" -q
6 passed in 0.93s
```

All files, commits, and functionality verified.

---
*Phase: 08.1-staging-keyset-single-source-of-truth*
*Completed: 2026-02-10*
